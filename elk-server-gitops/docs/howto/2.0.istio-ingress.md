# Objective
The objective of this README file is to provide an guideline to create a Istio Service Mesh. 

# Introduction 
This cluster will be managed by a Istio Service Mesh, you can read more details going to the link: https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/

# Istio Helm Template

* This is how the istio-install.yaml file was generated. For create a new template, please, consult the vendor page (https://istio.io/latest/docs/setup/additional-setup/customize-installation-helm/)

```
# helm template istio-ingress istio/gateway --namespace istio-ingress > ./base/service_mesh/istio-install.yaml
```

# Requirements
* Install the Istio CLI (istioctl): https://istio.io/latest/docs/setup/install/istioctl/

# Connect to AKS cluster and save the Kubeconfig
* Open Azure CLI
* Run the following commands: 
    ```
    1. Set the subscription as default: 
    - az account set --subscription <Subscription ID>
    2. Get the credentials to access the AKS cluster:
    - az aks get-credentials --resource-group <ResourceGroupName> --name <ClusterName>
    3. Copy to .kube path folder the reffered kubeconfig file: 
    - cp kubeconfig /home/<username>/.kube/config
    ```

# Istio Service Mesh install - Step 1

* Before to start the istio installation, warranty that we have helm repository added on your cluster.
```
# helm repo add istio https://istio-release.storage.googleapis.com/charts
```

* In overlays/<environment> directory, uncomment line 8 and 9, keep only those lines unconmment for this moment:

./overlays/<environment>/kustomization.yaml
```
bases:
 - ../../base
```

* In ./base root folder, locate kustomization.yaml file and uncomment line 6, that was respective for this line "- service_mesh":

./base/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
#- app
#- monitoring
- service_mesh
```

* It was a manifest file labeled "istio-install.yaml" inside of ./base/service_mesh directory. For install the istio, you must be enable "istio-install.yaml" in the kustomization.yaml file, like this:

./base/service_mesh/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
#- jaeger-install.yaml
#- kiali-install.yaml
- istio-install.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process. You can check using "flux get all"

```
# git add . && git commit -m "Installing istio on the Cluster" && git push
```

* Check the flux reconciliation progress:

```
# :~/repository/MSBoilerplate-GITOPS$ flux get all

NAME                                    REVISION        SUSPENDED       READY   MESSAGE                        
kustomization/dev                       main/70976fb    False           True    Applied revision: main/70976fb
kustomization/flux-system               main/70976fb    False           True    Applied revision: main/70976fb

```

* If the result of kustomization "dev" it's "Applied revision: main$$$$", the reconciliation process has been done. Where is "dev" is the "<cluster_name>" variable.

* You can check if the istio has been installed with success running the kubectl command line:

```
~/repository/MSBookinfo-GITOPS$ kubectl get pods -n istio-system
NAME                                    READY   STATUS    RESTARTS   AGE
istio-ingressgateway-546585745f-gxpqz   1/1     Running   0          2m35s
istiod-7f8c8bb8c8-nmvxd                 1/1     Running   0          2m35s
~/repository/MSBookinfo-GITOPS$ 
```

* We can see the pods in STATUS "Running", it indicates for us istio is working.

* An public ip address will be alocate for use to access the applications externally. You can check this using the kubectl command line. Like this:

```
~/repository/MSBookinfo-GITOPS$ kubectl get svc -n istio-system
NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)                                      AGE
istio-ingressgateway   LoadBalancer   10.0.185.250   20.82.156.73   15021:32339/TCP,80:31746/TCP,443:30214/TCP   3m18s
istiod                 ClusterIP      10.0.220.33    <none>         15010/TCP,15012/TCP,443/TCP,15014/TCP        3m18s
```

* The istio-ingressgateway allocated EXTERNAL-IP 20.82.156.73 in this case. This ip address will be change for each of istio deployment.

# Jaeger Installation - Step 2

* Jaeger is an open source end to end distributed tracing system, allowing users to monitor and troubleshoot transactions in complex distributed systems.

* For install Jaeger, go to ./base/service_mesh folder and enable jaeger-install.yaml file on the kustomization.yaml file inside of the ./base/service_mesh folder. Like this:

./base/service_mesh/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- jaeger-install.yaml
#- kiali-install.yaml
- istio-install.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process. You can check using "flux get all"

```
# git add . && git commit -m "Installing jaeger on the Cluster" && git push
```

* Check the flux reconciliation progress:

```
# :~/repository/MSBoilerplate-GITOPS$ flux get all

NAME                                    REVISION        SUSPENDED       READY   MESSAGE                        
kustomization/dev                       main/70976fb    False           True    Applied revision: main/70976fb
kustomization/flux-system               main/70976fb    False           True    Applied revision: main/70976fb

```

* Check if the jaeger pod was started with success

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n istio-system
NAME                                    READY   STATUS    RESTARTS   AGE
istio-ingressgateway-55df5d8468-wbhhx   1/1     Running   0          9m55s
istiod-7fb4bc46ff-vtxv5                 1/1     Running   0          9m54s
jaeger-cc4688b98-k7wrp                  1/1     Running   0          4m25s
```

* If we have a pod named jaeger-* with Running status, the deploy was done with success !!


# Prometheus Installation - Step 3

* Since Kiali depends on Prometheus we need to install Prometheus first!  

* Prometheus is an open-source systems monitoring and alerting toolkit originally built at SoundCloud. Prometheus collects and stores its metrics as time series data, i.e. metrics information is stored with the timestamp at which it was recorded, alongside optional key-value pairs called labels.

* For install Prometheus, in ./base root folder locate `kustomization.yaml` file and uncomment line 5, that was respective for this line "- monitoring":

./base/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
#- app
- monitoring
- service_mesh

* Then go to ./base/monitoring folder and enable `prometheus-install.yaml` file on the `kustomization.yaml` file inside of the ./base/monitoring folder. Like this:

./base/monitoring/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- prometheus-install.yaml
#- grafana-install.yaml
#- loki-install.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process. You can check using "flux get all"

```
# git add . && git commit -m "Installing prometheus on the Cluster" && git push
```

* Check if the prometheus pod was started with success

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n istio-system
NAME                                                 READY   STATUS    RESTARTS   AGE
istio-ingressgateway-55df5d8468-wbhhx                1/1     Running   0          13m
istiod-7fb4bc46ff-vtxv5                              1/1     Running   0          13m
jaeger-cc4688b98-k7wrp                               1/1     Running   0          8m19s
prometheus-74455d6bc7-4jddq                          2/2     Running   0          21d
prometheus-alertmanager-0                            1/1     Running   0          21d
prometheus-kube-state-metrics-75c7d7bc95-g8dj2       1/1     Running   0          21d
prometheus-prometheus-node-exporter-hhjwt            1/1     Running   0          21d
prometheus-prometheus-node-exporter-v88ll            1/1     Running   0          19d
prometheus-prometheus-pushgateway-56c86cc45f-bt78b   1/1     Running   0          21d
```

* If we have a pod named prometheus-* with Running status, the deploy was done with success !!


# Kiali Installation - Step 4

* Kiali is an observability console for Istio with service mesh configuration and validation capabilities. It helps you understand the structure and health of your service mesh by monitoring traffic flow to infer the topology and report errors. Kiali provides detailed metrics and a basic Grafana integration, which can be used for advanced queries. Distributed tracing is provided by integration with Jaeger.

* For install Kiali, go to ./base/service_mesh folder and enable kiali-install.yaml file on the kustomization.yaml file inside of the ./base/service_mesh folder. Like this:

./base/service_mesh/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- jaeger-install.yaml
- kiali-install.yaml
- istio-install.yaml
```

* Running a git push command for write changes on the repository and wait flux kustomization proccess finish.

```
# git add . && git commit -m "Installing kiali traffic tool and integrate with istio" && git push
```

* Check if the prometheus pod was started with success

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n istio-system
NAME                                                READY   STATUS    RESTARTS   AGE
istio-ingressgateway-55df5d8468-wbhhx                1/1     Running   0          13m
istiod-7fb4bc46ff-vtxv5                              1/1     Running   0          13m
jaeger-cc4688b98-k7wrp                               1/1     Running   0          8m19s
kiali-594965b98c-b2sl5                               1/1     Running   0          8m19s
prometheus-5f84bbfcfd-xj2cz                          2/2     Running   0          104s
prometheus-74455d6bc7-4jddq                          2/2     Running   0          21d
prometheus-alertmanager-0                            1/1     Running   0          21d
prometheus-kube-state-metrics-75c7d7bc95-g8dj2       1/1     Running   0          21d
prometheus-prometheus-node-exporter-hhjwt            1/1     Running   0          21d
prometheus-prometheus-node-exporter-v88ll            1/1     Running   0          19d
prometheus-prometheus-pushgateway-56c86cc45f-bt78b   1/1     Running   0          21d
```

* If we have a pod named kiali-* with Running status, the deploy was done with success !!

* For access kiali, run the istioctl command line. Like this:

```
# istioctl dashboard kiali
```

* or, with kubectl command line. Like this:

```
# kubectl -n monitoring port-forward svc/kiali 20001
```

* Open web browser and run http://localhost:20001

* For security reasons, the Kiali doesn't published on the internet, it's needed to provide only as a local access

**ISTIO INGRESS AND SERVICE MESH DONE**