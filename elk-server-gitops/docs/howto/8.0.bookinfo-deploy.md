# Objective
The objective of this README file is to provide an guideline to deploy an application. 

# Introduction 
We have an web application for deploy in our cluster, we can do this using GitOps process.

# Requirements
* Install the Kubernetes CLI (kubectl): https://kubernetes.io/docs/tasks/tools/

# Connect to AKS cluster and save the Kubeconfig
* Open Azure CLI
* Run the following commands: 
    ```
    1. Set the subscription as default: 
    - az account set --subscription <Subscription ID>
    2. Get the credentials to access the AKS cluster:
    - az aks get-credentials --resource-group <ResourceGroupName> --name <ClusterName>
    3. Copy to .kube path folder the reffered kubeconfig file: 
    - cp kubeconfig /home/<username>/.kube/config
    ```
* Only remember, we can be considered that we have sealed-secrets, cert-manager, istio-ingress implemented on the cluster for achieve success on this deployment. If you haven't this steps done, please, take care, the deployment process will be failed.

# Bookinfo App Deployment

* In ./base/app folder, locate root kustomization.yaml file and uncomment line 5, that was respective for this line "- bookinfo":

./base/app/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- blue
- bookinfo
#- busybox
```

* It has a manifest file labeled "bookinfo.yaml" inside of ./base/app/bookinfo folder. For deployment this application, we need to include bookinfo.yaml inside of kustomization.yaml file stored on ./base/app/bookinfo folder, like this:

./base/app/bookinfo/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- bookinfo.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Deployment bookinfo app on the Cluster" && git push
```

* Now, we can see if the application have been deployed with success running kubectl command line. Like this:

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n bookinfoapp
NAME                             READY   STATUS    RESTARTS   AGE
details-v1-6997d94bb9-6mfml      2/2     Running   0          48s
productpage-v1-d4f8dfd97-5fnsv   2/2     Running   0          47s
ratings-v1-b8f8fcf49-v54k9       2/2     Running   0          48s
reviews-v1-5896f547f5-5528z      2/2     Running   0          47s
reviews-v2-5d99885bc9-vtp8z      2/2     Running   0          48s
reviews-v3-589cb4d56c-hb498      2/2     Running   0          47s
```

* Consider that we need to have six pods in STATUS "Running". Each pod is a part of Bookinfo App application.

* Now, we need to provide external access for this application, we can do this using a istio ingress. For do this, gonna to ./clusters/dev-cluster/ingress folder and enable bookinfo-ingress.yaml file inside of kustomization.yaml stored on the ./clusters/dev-cluster/ingress folder. Like this:

./clusters/dev-cluster/ingress/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- blueapp-ingress.yaml
- bookinfo-ingress.yaml
```

* Before to do a git push, look at the ./clusters/<cluster_environment>/ingress/bookinfo-ingress.yaml.

**IMPORTANT** Even use the cert-secrets created that was running on the istio-system namespace, because as we have mTLS enabled, the certificate needs been provided by istio. Check the "credentialName:" parameter and warranty thtat was configured correctly with cert-secrets stored on istio-system. If needs change, do it, like this:

./clusters/<cluster_environment>/ingress/bookinfo-ingress.yaml
```
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway
  namespace: bookinfoapp
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      name: https
      number: 443
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: bookinfoistio # Always use the certificate secrets that's present on istio-system namespace here
    hosts:
      - bookinfo.blueapp.fun
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Enabling bookinfo app ingress for external access" && git push
```

* For see the URL path, we can use kubectl command line. Like this:

```
#:~/repository/MSBoilerplate-GITOPS$ kubectl get ingress -n bookinfoapp
NAME           CLASS    HOSTS         ADDRESS         PORTS   AGE
bookinfo-ingress   <none>   blueapp.fun   20.82.153.206   80      13m
```

* In our case, the URL path is "https://bookinfo.blueapp.fun/productpage". Open your web browser and put this address there.

**BOOKINFO SETUP DONE**