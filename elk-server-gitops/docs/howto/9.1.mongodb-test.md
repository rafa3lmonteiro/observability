# MongoDB Test

This document is dedicated to the MongoDB testing.

Assumptions:
- MongoDB Community Operator is already installed in the cluster.
- MongoDB ReplicaSet is already deployed in the cluster 


1. Connect to MongoDB

* First we need to expose MongoDB by doing:

```
kubectl port-forward example-mongodb-0 27017:27017 -n mongodb
```

You can use [mongoshell](https://www.mongodb.com/docs/mongodb-shell/install/#std-label-mdb-shell-install) as client to connect to MongoDB.


* Then use the following command to connect to MongoDB:

```
mongosh --username mongo-admin --password --authenticationDatabase admin --host localhost --port 27017
```

The password to use is the password defined in the MongoDB ReplicaSet deploy step.

* To see the existing databases use the command:
```
show dbs
```

You shoudl see the following:
```
example-mongodb [direct: primary] test> show dbs
admin   172.00 KiB
config  176.00 KiB
local   900.00 KiB
example-mongodb [direct: primary] test> 
```

2. Create a new database

* Select an existing database or create a new database (if not exist) with `use` command:
```
use test
```

3. Create a new user to access the database

* A user can be created doing:
```
db.createUser({user: "mongo-test", pwd: "mongo-test",roles: [{role: "readWrite", db: "test"}]})
```

4. Coonect to the test database with the new user

Let's connect to the `test` databse with the `mongo-test` user:
```
mongosh --username mongo-test --password mongo-test --authenticationDatabase test --host localhost --port 27017
```

Note: If the you do `show dbs` you will not "see" any database since the database `test` is empty. As soon a collection is created the database will become visible. 

5. Create a collection and a document

* Create a new collection:
```
db.createCollection("test_collection00")
```


* Check that collection `test_collection00` was created by doing:
```
show collections
```

```
example-mongodb [direct: primary] test> show dbs
test  8.00 KiB
example-mongodb [direct: primary] test> 
```

* Let's create a document in that collection:

```
db.test_collection00.insert( { name: "A nice document"} )
```

* Check the created documet by doing:
```
db.test_collection00.find()
```

You should get the following result:
```
example-mongodb [direct: primary] test> db.test_collection00.find()
[
  {
    _id: ObjectId("6465edbfb6c761b55942dcf3"),
    name: 'A nice document'
  }
]
example-mongodb [direct: primary] test> 
```


5. It's time to test the persistence.

The plan is to delete the pods and confirm that we do not lose data.

* So, let's start by delete one of the pods:
```
kubectl delete pod example-mongodb-0 -n mongodb
``` 

```
~/repository/MSBookinfo-GITOPS$ kubectl get pods -n mongodb
NAME                                         READY   STATUS     RESTARTS   AGE
example-mongodb-0                            0/2     Init:0/2   0          3s
example-mongodb-1                            2/2     Running    0          18h
example-mongodb-2                            2/2     Running    0          18h
mongodb-kubernetes-operator-8d6f8cf7-lsbb4   1/1     Running    0          18h
```

* The deleted pod (example-mongodb-0 ) will be recreated by Flux. Meanwhile, the ReplicaSet will elect a new master and we can connect to it by doing:

```
# kubectl port-forward example-mongodb-1 27017:27017 -n mongodb
```

* The validate that the data was persisted we can do:

```
mongosh --username mongo-test --password mongo-test --authenticationDatabase test --host localhost --port 27017
```

```
use test
```

```
db.test_collection00.find()
```

The result should be:
```
example-mongodb [direct: primary] test> db.test_collection00.find()
[
  {
    _id: ObjectId("6465edbfb6c761b55942dcf3"),
    name: 'A nice document'
  }
]
example-mongodb [direct: primary] test> 
```

**MONGODB TEST DONE**
