# Objective
The objective of this README file is to provide an guideline to create and install prometheus with grafana monitoring tools. 

# Introduction 
This cluster will be monitored by a Prometheus and Grafana, you can read more details going to the link: https://grafana.com/docs/grafana/latest/introduction/

# Grafana-Loki Helm Template

* This is how the grafana-install.yaml and loki-install.yaml file was generated. For create a new template, please, consult the vendor page (https://grafana.com/docs/helm-charts/)

```
# helm template grafana grafana/grafana --namespace istio-system > ./base/monitoring/grafana-install.yaml
# helm template loki grafana/loki-stack --namespace istio-system > ./base/monitoring/loki-install.yaml
```

# Requirements
* Install the Kubectl CLI: https://kubernetes.io/docs/tasks/tools/
# Connect to AKS cluster and save the Kubeconfig
* Open Azure CLI
* Run the following commands: 
    ```
    1. Set the subscription as default: 
    - az account set --subscription <Subscription ID>
    2. Get the credentials to access the AKS cluster:
    - az aks get-credentials --resource-group <ResourceGroupName> --name <ClusterName>
    3. Copy to .kube path folder the reffered kubeconfig file: 
    - cp kubeconfig /home/<username>/.kube/config
    ```

# Prometheus Installation

* **If you already deployed Prometheus on the (2.0.istio-ingress)[docs/howto/2.0.istio-ingress.md] step you can skip this Prometheus installation step.**

* In ./base root folder, locate kustomization.yaml file and uncomment line 5, that was respective for this line "- monitoring":

./base/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
#- app
- monitoring
- service_mesh
```

* It was a manifest file labeled "prometheus-install.yaml" inside of ./base/monitoring directory. For install the prometheus stack, you must be enable "prometheus-install.yaml" in the kustomization.yaml file, like this:

./base/monitoring/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- prometheus-install.yaml
#- grafana-install.yaml
#- loki-install.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Installing Prometheus Monitoring" && git push
```

* Check if the prometheus pods was started with success !!!

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n istio-system
NAME                                                 READY   STATUS    RESTARTS   AGE
istio-ingressgateway-7547496c5b-ptngp                1/1     Running   0          21d
istiod-85fdd8c5-5gzqs                                1/1     Running   0          21d
jaeger-cc4688b98-mjw95                               1/1     Running   0          21d
kiali-58c5bfcbb-d6d67                                1/1     Running   0          21d
prometheus-74455d6bc7-4jddq                          2/2     Running   0          21d
prometheus-alertmanager-0                            1/1     Running   0          21d
prometheus-kube-state-metrics-75c7d7bc95-g8dj2       1/1     Running   0          21d
prometheus-prometheus-node-exporter-hhjwt            1/1     Running   0          21d
prometheus-prometheus-node-exporter-v88ll            1/1     Running   0          19d
prometheus-prometheus-pushgateway-56c86cc45f-bt78b   1/1     Running   0          21d
```


# Grafana Installation

* It was a manifest file labeled "grafana-install.yaml" inside of ./base/monitoring directory. For install the Grafana, you must be enable "grafana-install.yaml" in the kustomization.yaml file, like this:

./base/monitoring/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- prometheus-install.yaml
- grafana-install.yaml
#- loki-install.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Installing Grafana Monitoring" && git push
```

* Check if the grafana pod was started with success !!!

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n istio-system
NAME                                                 READY   STATUS    RESTARTS   AGE
grafana-659db57f99-llnb8                             1/1     Running   0          21d
istio-ingressgateway-7547496c5b-ptngp                1/1     Running   0          21d
istiod-85fdd8c5-5gzqs                                1/1     Running   0          21d
jaeger-cc4688b98-mjw95                               1/1     Running   0          21d
kiali-58c5bfcbb-d6d67                                1/1     Running   0          21d
prometheus-74455d6bc7-4jddq                          2/2     Running   0          21d
prometheus-alertmanager-0                            1/1     Running   0          21d
prometheus-kube-state-metrics-75c7d7bc95-g8dj2       1/1     Running   0          21d
prometheus-prometheus-node-exporter-hhjwt            1/1     Running   0          21d
prometheus-prometheus-node-exporter-v88ll            1/1     Running   0          19d
prometheus-prometheus-pushgateway-56c86cc45f-bt78b   1/1     Running   0          21d
```

# Loki Installation

* It was a manifest file labeled "loki-install.yaml" inside of ./base/monitoring directory. For install the Loki extension, you must be enable "loki-install.yaml" in the kustomization.yaml file, like this:

./base/monitoring/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- prometheus-install.yaml
- grafana-install.yaml
- loki-install.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Installing Loki Extension" && git push
```

* Check if the Loki pods was started with success !!!

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n istio-system
NAME                                                 READY   STATUS    RESTARTS   AGE
grafana-659db57f99-llnb8                             1/1     Running   0          21d
istio-ingressgateway-7547496c5b-ptngp                1/1     Running   0          21d
istiod-85fdd8c5-5gzqs                                1/1     Running   0          21d
jaeger-cc4688b98-mjw95                               1/1     Running   0          21d
kiali-58c5bfcbb-d6d67                                1/1     Running   0          21d
loki-0                                               1/1     Running   0          21d
loki-promtail-fp9h4                                  1/1     Running   0          21d
loki-promtail-ntlxn                                  1/1     Running   0          19d
prometheus-74455d6bc7-4jddq                          2/2     Running   0          21d
prometheus-alertmanager-0                            1/1     Running   0          21d
prometheus-kube-state-metrics-75c7d7bc95-g8dj2       1/1     Running   0          21d
prometheus-prometheus-node-exporter-hhjwt            1/1     Running   0          21d
prometheus-prometheus-node-exporter-v88ll            1/1     Running   0          19d
prometheus-prometheus-pushgateway-56c86cc45f-bt78b   1/1     Running   0          21d
```

**WARNING** It's very important to warranty the Grafana, Prometheus and Loki doesn't published on the internet, only local network.

* For access grafana, please, follow this instructions

* For get the admin password generated during the installation, run this command line below:

```
# kubectl get secret --namespace istio-system grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo
```

```
# kubectl port-forward grafana-659db57f99-llnb8 3000:3000 -n istio-system
```

* Open your browser and type "http://localhost:3000"

Username: admin
Password: <output of get secret command>

**MONITORING TOOLS DONE**