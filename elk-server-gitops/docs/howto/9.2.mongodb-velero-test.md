# MongoDB - Velero Test

## Create backup for mongodb namespace

We will create a backup of the name space mongodb, this includes the persistent volumes of the MongoDB replicaset.

* For creating a backup on demand we will use the command:

```
velero backup create NAME-OF-THE-BACKUP --include-namespaces NAME-OF-THE-NAMESPACE --storage-location NAME-OF-THE-BACKUP-STORAGE-LOCATION
```

For getting the backup storage location you can do:
```
velero backup-location get
```

You should get the following result:
```
DEVO-2021051524:MSBoilerplate-GITOPS eduardopiairo$  velero backup-location get
NAME    PROVIDER   BUCKET/PREFIX   PHASE       LAST VALIDATED                   ACCESS MODE   DEFAULT
azure   azure      mycluster       Available   2023-05-28 15:54:17 +0100 WEST   ReadWrite     
```

So, the velero backup command will be:
```
velero backup create mongodb-replicasetbackup00 --include-namespaces mongodb --storage-location azure
```

You will get the following result:
```
DEVO-2021051524:MSBoilerplate-GITOPS eduardopiairo$ velero backup create mongodb-replicasetbackup00 --include-namespaces mongodb --storage-location azure
Backup request "mongodb-replicasetbackup00" submitted successfully.
Run `velero backup describe mongodb-replicasetbackup00` or `velero backup logs mongodb-replicasetbackup00` for more details.
```

For checking the state of the backup process you can use the commands
```
velero backup describe mongodb-replicasetbackup00
or
velero backup logs mongodb-replicasetbackup00
```

Additionally, you can go to the Azure Subscritpion, and in the resource group check if the backup was created.


## Restore backup for mongodb namespace


Now it's time to validate the restore of the backup created above.

We will simulate that we, for some reason, have lost, the resources of the namespace mongodb.

* Let's start by removing the resources of the mongodb namespace by commenting the file `base/db/kustomization.yaml`:
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
#- mongodb
```

* Flux will remove the resources in mongodb namespace, but will not delete the persisten volumes. You can check that by doing:
```
kubectl get pvc -n mongodb
```

You should get:
```
NAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
data-volume-example-mongodb-0   Bound    pvc-73fba910-5c57-4ab8-bdc0-78e2d465cbbe   10Gi       RWO            default        3d3h
data-volume-example-mongodb-1   Bound    pvc-30f9b435-f384-4c87-83ee-1be4266eb523   10Gi       RWO            default        3d3h
data-volume-example-mongodb-2   Bound    pvc-431a9fc4-3b31-4889-b1a7-ed1625d1d461   10Gi       RWO            default        3d3h
logs-volume-example-mongodb-0   Bound    pvc-cba3c997-12e7-400c-8268-578c318b2714   2Gi        RWO            default        3d3h
logs-volume-example-mongodb-1   Bound    pvc-c1b86b46-df46-4c6c-9ba5-f2c195d4202d   2Gi        RWO            default        3d3h
logs-volume-example-mongodb-2   Bound    pvc-3b6c8153-bf61-4ded-9161-7b246676fe83   2Gi        RWO            default        3d3h
```

You can delete the persistent volumes by doing:

```
kubectl delete pvc data-volume-example-mongodb-0 -n mongodb
kubectl delete pvc data-volume-example-mongodb-1 -n mongodb
kubectl delete pvc data-volume-example-mongodb-2 -n mongodb
kubectl delete pvc logs-volume-example-mongodb-0 -n mongodb
kubectl delete pvc logs-volume-example-mongodb-1 -n mongodb
kubectl delete pvc logs-volume-example-mongodb-2 -n mongodb
```

* Lets apply the restore:

```
velero restore create --from-backup NAME-OF-THE-BACKUP
```

Example:
```
velero restore create --from-backup mongodb-replicasetbackup00
```

You will get the result:
```
DEVO-2021051524:MSBoilerplate-GITOPS eduardopiairo$ velero restore create --from-backup mongodb-replicasetbackup00
Restore request "mongodb-replicasetbackup00-20230528162735" submitted successfully.
```

You can use the following commands to get more details about the restore process:
```
velero restore describe mongodb-replicasetbackup00-20230528162735
or 
velero restore logs mongodb-replicasetbackup00-20230528162735.
```

* Check if the data is there.

First let's make port forward:

```
kubectl port-forward example-mongodb-0 27017:27017 -n mongodb
```

You can use the user createad in the 'docs/howto/9.1.mongodb-test.md' 
```
mongosh --username mongo-test --password mongo-test --authenticationDatabase test --host localhost --port 27017
```

And then, use the query to check id the data still there:
```
db.test_collection00.find()
```

The result should be:
```
example-mongodb [direct: primary] test> db.test_collection00.find()
[
  {
    _id: ObjectId("646613e869dfc2912ddf18bf"),
    name: 'A nice document'
  }
]
example-mongodb [direct: primary] test> 
```

**MONGODB NAMESPACE BACKUP AND RESTORE TEST DONE**


## Usefull velero commands 

### List backups 
```
velero backup get
```

### Delete backup
```
velero backup delete NAME-OF-THE-BACKUP
```