# Kubeseal - Sealed Secrets

# Requirements

* Install the Sealed Secrets CLI (kubeseal): https://fluxcd.io/flux/guides/sealed-secrets/

# Sealed Secrets install - Step 1

* In ./clusters/<cluster_name> root folder, locate kustomization.yaml file and uncomment line 6, that was respective for this line "- secrets":

./clusters/<cluster_name>/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- cert
- flux-system
- secrets
#- ingress
```

* It has a manifest file labeled "sealed-secrets-install.yaml" inside of ./clusters/<cluster_name>/secrets directory. For execute the sealed secrets installation, must be included in the kustomization.yaml file an new line with the file name, like this:

./clusters/<cluster_name>/secrets/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
#- <environemnt>-sealed-secrets.yaml
- sealed-secrets-install.yaml
```

* Do the git push command for update the repository and deploy sealed secrets inside of the Kubernetes Cluster

```
# git add . && git commit -m "Installing sealed secrets" && git push
```

## Usage - Step 2
After installation of the controller, you can get the public key and store it publicly, so that it can be used, if needed, by anyone trying to encrypt secrets. To get the public key and store it in a file, run the following command (make sure you are using the correct k8s context):

dev:
```
# kubeseal --context $(kubectl config current-context) --controller-namespace flux-system --controller-name sealed-secrets --fetch-cert >./clusters/<cluster_name>/secrets/<environment>-sealed-secrets.pem
```

* Do the git push command for update the repository for upload the secrets certifcate inside of the Secrets folder

```
# git add . && git commit -m "Upload certificate generated for dev cluster" && git push
```

To add a k8s secret config file to this repo, in a secure manner, do the following:

* Encode in base64 all sensitive strings: `echo -n '<string>' | base64`;
* Create a k8s secret yaml file (`original-secrets-<environment>.yaml`), in the "normal" fashion (https://kubernetes.io/docs/tasks/configmap-secret/managing-secret-using-config-file/#create-the-config-file), as shown in the below example:

**WARNING**: don't store or do a git push with original-secrets-<environment>.yaml file while the encryptation process has been done, because this file have a encoded base64 string and if was stored on the repository, we cannot are responsible for credential expose. Be careful and remove the original-secrets-<environment>.yaml file before to do a git push command.

* Manifest file example
```
apiVersion: v1
kind: Secret
metadata:
  name: <app_name>-secrets
  namespace: <secrets_namespace>
type: Opaque
data:
  SECRETS_1: <base64 encoded string>
  SECRETS_2: <base64 encoded string>
```
  
* Do the echo base64 for each SECRETS that you wanna to store on the secrets vault

```
# echo -n 'teste' | base64
dGVzdGU=
# echo -n 'teste2' | base64
dGVzdGUy
```

* Create an file to create a secret for Grafana with admin-user and admin-password for grafana, like this:

```
# cat << EOF > ./clusters/<cluster_name>/secrets/original-secrets-grafana.yaml
apiVersion: v1
kind: Secret
metadata:
  name: grafana
  namespace: istio-system
type: Opaque
data:
  admin-user: YWRtaW4=
  admin-password: S09nVG9kSEI5b1ZQNWdKNmpaR1V4dFkxeDZvRDN1d3ZYN2lxa0ZQdQ==
EOF
```

**IMPORTANT** Change the secret value from "admin-password" using base64 and after, use the SSL certificate from sealed-secrets to encrypt the result. Inside of grafana-install.yaml, Grafana will be look for these variables and secrets for get the username and password, don't change the variables name, only the content of these.

**REMEMBER** to insert the result of each SECRETS on the original-secrets-<environment>.yaml file below:

```
# cat << EOF > ./clusters/<cluster_name>/secrets/original-secrets-<environment>.yaml
apiVersion: v1
kind: Secret
metadata:
  name: blueapp-secrets
  namespace: blueapp
type: Opaque
data:
  SECRETS_1: dGVzdGU=
  SECRETS_2: dGVzdGUy
EOF
```

**IMPORTANT**: Do not manipulate the above file in your local Git folder! This will prevent accidental commits of sensitive information in clear text to the repository! Make sure you only commit the encrypted file (see next steps)!

* Encrypt the above file, using the following command: 

```
# kubeseal -o yaml --context $(kubectl config current-context) --controller-namespace flux-system --controller-name sealed-secrets --cert=./clusters/<cluster_name>/secrets/<environment>-sealed-secrets.pem <./clusters/<cluster_name>/secrets/original-secrets-<environment>.yaml >./clusters/<cluster_name>/secrets/<environment>-sealed-secrets.yaml
```

* Example

```
kubeseal -o yaml --context $(kubectl config current-context) --controller-namespace flux-system --controller-name sealed-secrets --cert=./clusters/dev-cluster/secrets/dev-sealed-secrets.pem <./clusters/dev-cluster/secrets/original-secrets-dev.yaml >./clusters/dev-cluster/secrets/dev-sealed-secrets.yaml
```

* Encrypt the Grafana Secrets file

```
kubeseal -o yaml --context $(kubectl config current-context) --controller-namespace flux-system --controller-name sealed-secrets --cert=./clusters/dev-cluster/secrets/dev-sealed-secrets.pem <./clusters/dev-cluster/secrets/original-secrets-grafana.yaml >./clusters/dev-cluster/secrets/grafana-sealed-secrets.yaml
```

# Removing original secrets file

```
# rm ./clusters/<cluster_name>/secrets/original-secrets-<environment>.yaml
```

```
# rm ./clusters/<cluster_name>/secrets/original-secrets-grafana.yaml
```

* It has a manifest file labeled "<environment>-sealed-secrets.yaml" inside of ./clusters/<cluster_name>/secrets directory. For upload and apply the encrypt secret file, must be included in the kustomization.yaml file an new line with the file name, like this:

```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- <environment>-sealed-secrets.yaml
- grafana-sealed-secrets.yaml
- sealed-secrets-install.yaml
```

* Run git command for store the modifications on the repository

```
git add . && git commit -m "Uploading sealed secrets encrypted file to cluster" && git push
```

* Check if the secret vault "blueapp-secret" of "Opaque" type was created with success

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get secret -n blueapp
NAME              TYPE                DATA   AGE
blueapp-secrets   Opaque              2      23s
blueappsecret     kubernetes.io/tls   2      72m
```

**SEALED SECRETS INSTALL DONE**