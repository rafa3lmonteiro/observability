# Objective
The objective of this README file is to provide an guideline to deploy an application. 

# Introduction 
We have an web application for deploy in our cluster, we can do this using GitOps process.

# Requirements
* Install the Kubernetes CLI (kubectl): https://kubernetes.io/docs/tasks/tools/

# Connect to AKS cluster and save the Kubeconfig
* Open Azure CLI
* Run the following commands: 
    ```
    1. Set the subscription as default: 
    - az account set --subscription <Subscription ID>
    2. Get the credentials to access the AKS cluster:
    - az aks get-credentials --resource-group <ResourceGroupName> --name <ClusterName>
    3. Copy to .kube path folder the reffered kubeconfig file: 
    - cp kubeconfig /home/<username>/.kube/config
    ```
* Only remember, we can be considered that we have sealed-secrets, cert-manager, istio-ingress implemented on the cluster for achieve success on this deployment. If you haven't this steps done, please, take care, the deployment process will be failed.

#  MongoDB Community Operator Deployment

* Before to start the MongoDB Operator installation, make sure to add the helm repository to your cluster.
```
# helm repo add mongodb https://mongodb.github.io/helm-charts
```

* The MongoDB operator will be deployed in namespace `mongodb`. Make sure that the namespace exists. If not, create it:
```
# kubectl apply -f ./base/namespace.yaml
```

* The next step is to generate the file community-operator-install.yaml. For that we use the helm template instruction. 
```
# helm template community-operator mongodb/community-operator --namespace mongodb > ./base/db/mongodb/community-operator/community-operator-install.yaml
```

* In ./base folder, locate root kustomization.yaml file and uncomment line 8, that was respective for this line "- db":

./base/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- app
- monitoring
- service_mesh
- velero
- db
```

* In ./base/db folder, locate root kustomization.yaml file and uncomment line 4, that was respective for this line "- mongodb":

./base/db/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- mongodb
```

* In ./base/db/mongodb folder, locate root kustomization.yaml file and uncomment line 4, that was respective for this line "- community-operator":

./base/db/mongodb/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- community-operator
#- mongodb
```

* It has a manifest file labeled `community-operator-install.yaml` inside of ./base/db/mongodb/comunity-operator folder. To deploy the MongoDb Community operator we need to include community-operator-install.yaml inside of kustomization.yaml file stored on ./base/db/mongodb/community-operator folder, like this:

./base/db/mongodb/community-operator/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- community-operator-install.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Deploy mongodb community operator in the Cluster" && git push
```

* Now, we can see if the application have been deployed with success running kubectl command line. Like this:

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n mongodb
NAME                                         READY   STATUS    RESTARTS   AGE
mongodb-kubernetes-operator-8d6f8cf7-r2rgt   1/1     Running   0          28m
```

* Next step is to deploy MongoDB ReplicaSet.


#  MongoDB ReplicaSet Deployment

*  You can find the MongoDB Community ReplicaSet in base/db/mongodb/mongodb/mongodb-install.yaml.

* We will need a user and a password to access the MongoDB database. The user is `mongo-admin` (It's definied in the file base/db/mongodb/mongodb/mongodb-install.yaml).

* Create an file to create a secret for MongoDB:

```
# cat << EOF > ./clusters/<cluster_name>/secrets/original-secrets-mongodb.yaml
apiVersion: v1
kind: Secret
metadata:
  name: mongo-admin-password
  namespace: mongodb
type: Opaque
stringData:
  password: YVZlcnlOaWNlUGFzc3cwcmQ=
EOF
```

* Encrypt the above file, using the following command: 

```
# kubeseal -o yaml --context <cluster_name_context> --controller-namespace flux-system --cert=./clusters/<cluster_name>/secrets/<environment>-sealed-secrets.pem <./clusters/<cluster_name>/secrets/original-secrets-mongodb.yaml >./clusters/<cluster_name>/secrets/mogodb-sealed-secrets.yaml
```

* Example

```
kubeseal -o yaml --context aks-lab-neu-1 --controller-namespace flux-system --cert=./clusters/dev-cluster/secrets/dev-sealed-secrets.pem <./clusters/dev-cluster/secrets/original-secrets-mongodb.yaml >./clusters/dev-cluster/secrets/mongodb-sealed-secrets.yaml
```

**IMPORTANT**: Make sure you only commit the encrypted file!


* It has a manifest file labeled "<environment>-sealed-secrets.yaml" inside of ./clusters/<cluster_name>/secrets directory. For upload and apply the encrypt secret file, must be included in the kustomization.yaml file an new line with the file name, like this:

```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- <environment>-sealed-secrets.yaml
- grafana-sealed-secrets.yaml
- sealed-secrets-install.yaml
- mongodb-sealed-secrets.yaml
```

* Run git command for store the modifications on the repository

```
git add . && git commit -m "Uploading sealed secrets encrypted file for MongoDB" && git push
```

* In ./base/db/mongodb folder, locate root kustomization.yaml file and uncomment line 5, that was respective for this line "- mongodb":

./base/db/mongodb/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- community-operator
- mongodb
```

* It has a manifest file labeled `mongodb-filesystem-install.yaml` inside of ./base/db/mongodb/mongodb folder. This will create a strage class with the name `mongodb-storage-class` wich file system type is `xfs`. Inside of the kustomization.yaml file stored on ./base/db/mongodb/mongodb folder uncomment line 4:

./base/db/mongodb/mongodb/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- mongodb-filesystem-install.yaml
#- mongodb-install.yaml
```

* It has a manifest file labeled `mongodb-install.yaml` inside of ./base/db/mongodb/mongodb folder. To deploy the MongoDb Community ReplicaSet we need to include mongodb-install.yaml inside of kustomization.yaml file stored on ./base/db/mongodb/mongodb folder, like this (line 5):

./base/db/mongodb/mongodb/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- mongodb-filesystem-install.yaml
- mongodb-install.yaml
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Deploy mongodb community replicaset in the Cluster" && git push
```

* Now, we can see if the application have been deployed with success running kubectl command line. Like this:

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n mongodb
NAME                                         READY   STATUS    RESTARTS   AGE
example-mongodb-0                            2/2     Running   0          2m36s
example-mongodb-1                            2/2     Running   0          2m2s
example-mongodb-2                            2/2     Running   0          98s
mongodb-kubernetes-operator-8d6f8cf7-r2rgt   1/1     Running   0          124m
```

**MONGODB SETUP DONE**