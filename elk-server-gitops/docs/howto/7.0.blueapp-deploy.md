# Objective
The objective of this README file is to provide an guideline to deploy an application. 

# Introduction 
We have an web application for deploy in our cluster, we can do this using GitOps process.

# Requirements
* Install the Kubernetes CLI (kubectl): https://kubernetes.io/docs/tasks/tools/

# Connect to AKS cluster and save the Kubeconfig
* Open Azure CLI
* Run the following commands: 
    ```
    1. Set the subscription as default: 
    - az account set --subscription <Subscription ID>
    2. Get the credentials to access the AKS cluster:
    - az aks get-credentials --resource-group <ResourceGroupName> --name <ClusterName>
    3. Copy to .kube path folder the reffered kubeconfig file: 
    - cp kubeconfig /home/<username>/.kube/config
    ```
* Only remember, we can be considered that we have sealed-secrets, cert-manager, istio-ingress implemented on the cluster for achieve success on this deployment. If you haven't this steps done, please, take care, the deployment process will be failed.

# Blue App Deployment

* In ./base root folder, locate root kustomization.yaml file and uncomment line 4, that was respective for this line "- app":

./base/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- app
- monitoring
- service_mesh
```

* In ./base/app folder, locate root kustomization.yaml file and uncomment line 4, that was respective for this line "- blue":

./base/app/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- blue
#- bookinfo
#- busybox
```

* It has a manifest file labeled "blue-deploy.yaml" inside of ./base/app/blue folder. For deployment this application, we need to include blue-deploy.yaml inside of kustomization.yaml file stored on ./base/app/blue folder, like this:

./base/app/blue/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- blue-deploy.yaml
```

* Go to the ./overlays/<environment>, locate the root kustomization.yaml file and uncoment lines 10, 11, 12, 13 and 14, that was respective to the patches, like this:

```
# bases:
# - ../../base
# patches:
# - path: <file>.yaml
#   target:
#     kind: Deployment # Type of manifest, can be Deployment, CronJob, etc
#     name: <app_name>
bases:
 - ../../base
patches:
 - path: blueapp-deployment.yaml
   target:
     kind: Deployment
     name: blueapp
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Deployment blueapp app on the Cluster" && git push
```

* Now, we can see if the application have been deployed with success running kubectl command line. Like this:

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get pods -n blueapp
NAME                           READY   STATUS    RESTARTS   AGE
blue-deploy-69558f8dd6-8mwh9   2/2     Running   0          2m39s
```

# Blue App Ingress

*  In ./clusters/<cluster_environment> folder, locate root kustomization.yaml file and uncomment line 7, that was respective for this line "- ingress":

./clusters/<cluster_environment>/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- cert
- flux-system
- secrets
- ingress
```

* Now, we need to provide external access for this application, we can do this using a istio ingress. For do this, gonna to ./clusters/<cluster_environment>/ingress folder and enable blueapp-ingress.yaml file inside of kustomization.yaml stored on the ./clusters/<cluster_environment>/ingress folder. Like this:

./clusters/<cluster_environment>/ingress/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- blueapp-ingress.yaml
#- bookinfo-ingress.yaml
```

* Before to do a git push, look at the ./clusters/<cluster_environment>/ingress/blueapp-ingress.yaml.

**IMPORTANT** Even use the cert-secrets created that was running on the istio-system namespace, because as we have mTLS enabled, the certificate needs been provided by istio. Check the "credentialName:" parameter and warranty that was configured correctly with cert-secrets stored on istio-system. If needs change, do it, like this:

./clusters/<cluster_environment>/ingress/blueapp-ingress.yaml
```
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: blue-gateway
  namespace: blueapp
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      name: https
      number: 443
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: blueappistio # Always use the certificate secrets that's present on istio-system namespace here
    hosts:
      - blueapp.fun
```

* After this, do a git push to upload the manifest file in the repository and wait until flux and kustomize finish the reconciliation process.

```
# git add . && git commit -m "Enabling blueapp ingress for external access" && git push
```

* For see the URL path, we can use kubectl command line. Like this:

```
#:~/repository/RUN3-MSBoilerplate-GITOPS$ kubectl get ingress -n blueapp
NAME           CLASS    HOSTS         ADDRESS         PORTS   AGE
blue-ingress   <none>   blueapp.fun   51.104.147.67   80      74s
```

* For given external access, keep in your mind to create a A record appointment on your public DNS from IP <ip_address_ingress_gateway> to the blueapp.fun.

**LOCAL TEST** you can configure on your local hosts file an input appointment for test.

* Include this line in the end of the local hosts file, located in C:\Windows\System32\Drivers\etc\hosts

```
<ip_address_ingress_gateway>    blueapp.fun
``` 

* In our case, the URL path is "https://blueapp.fun". Open your web browser and put this address there.

**BLUE APP DEPLOYED DONE**