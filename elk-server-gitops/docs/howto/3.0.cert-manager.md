# Objective
The objective of this README file is to provide an guideline to create a cert-manager controller, using helm repo and AKS. 

# Introduction 
This cluster will be managed by a cert-manager controller, you can read more details going to the link: https://cert-manager.io/docs/

# Requirements
* Install the Kubernetes CLI (kubectl): https://kubernetes.io/docs/tasks/tools/

# Connect to AKS cluster and save the Kubeconfig
* Open Azure CLI
* Run the following commands: 
    ```
    1. Set the subscription as default: 
    - az account set --subscription <Subscription ID>
    2. Get the credentials to access the AKS cluster:
    - az aks get-credentials --resource-group <ResourceGroupName> --name <ClusterName>
    3. Copy to .kube path folder the reffered kubeconfig file: 
    - cp kubeconfig /home/<username>/.kube/config
    ```

# Cert-Manager install - Step 1

* In ./clusters/<cluster_name> root folder, locate kustomization.yaml file and uncomment line 4, that was respective for this line "- cert":

./clusters/<cluster_name>/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- cert
- flux-system
#- secrets
#- ingress
```

* It has a manifest file labeled "cert-manager-install.yaml" inside of ./clusters/<cluster_name>/cert directory. For execute the cert-manager installation, must be included in the kustomization.yaml file an new line with the file name, like this:

./clusters/<cluster_name>/cert/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- cert-manager-install.yaml
```

* Do the git push command for update the repository and deploy cert-manager inside of the Kubernetes Cluster

```
# git add . && git commit -m "Installing cert-manager" && git push
```

# Creation secrets for applications - Step 2

* At this point, it's necessary create a secret inside of Kubernetes. We can create this using the kubectl CLI, like:
* Obs: It's very important create the secret at the same namespace that hosted the application.

```
# kubectl create -n <app_namespace> secret tls <secret-name> --key <path-to-key> --cert <path-to-cert>
```

* Executing the example above with the CTT environment variables:

```
# kubectl create -n istio-system secret tls <secret_name> --key ./clusters/<cluster_name>/cert/<certificate_key>.key --cert ./clusters/<cluster_name>/cert/<certificate>.crt
```

* Repeat this steps for each namespace that are need, like blueapp and bookinfoapp

**WARNING** Istio needed to have an cert-manager secret created on istio-system namespace for TLS working. Then, create the certificate secrets on both namespaces, like istio-system, blueapp and bookinfoapp namespaces.

**IMPORTANT** In the ingress credentialName, always use the certificate secrets created on the istio-system namespace

* Blue app Secrets Creation Step

istio-system namespace 
```
# kubectl create -n istio-system secret tls blueappistio --key ./clusters/<cluster_name>/cert/blueapp.fun.key --cert ./clusters/<cluster_name>/cert/blueapp.fun.crt
```

blueapp namespace
```
# kubectl create -n blueapp secret tls blueappsecret --key ./clusters/<cluster_name>/cert/blueapp.fun.key --cert ./clusters/<cluster_name>/cert/blueapp.fun.crt
```


* Bookinfo App Secrets Creation Step

istio-system namespace
```
# kubectl create -n istio-system secret tls bookinfoistio --key ./clusters/<cluster_name>/cert/bookinfo.blueapp.fun.key --cert ./clusters/<cluster_name>/cert/bookinfo.blueapp.fun.crt
```

bokkinfoapp namespace
```
# kubectl create -n bookinfoapp secret tls bookinfoappsecret --key ./clusters/<cluster_name>/cert/bookinfo.blueapp.fun.key --cert ./clusters/<cluster_name>/cert/bookinfo.blueapp.fun.crt
```


**CERT-MANAGER SETUP DONE**