# Velero Backup

If you periodically back up your clusterâ€™s resources, you are able to return to a previous state in case of some unexpected mishap, such as a service outage. 


## Backup Definition

| Type of backup            | Description               | Frequency     | Retention         |
| -----------------------   | --------------------      | ------        | 30 days (default) |
| Flux                      | flux-system resources     | daily         | 30 days (default) |
| Prometheus database       | istio-system pvc and pv   | daily         | 30 days (default) |
| MongoDB replicaset        | monogdb pvc and pv        | hourly        | 30 days (default) | 


## Schedule Backups

Whe can schedule a backup to a specific time   using the folowing command:

```
velero schedule create SCHEDULE-NAME --schedule "0 7 * * *"
```

### Backup flux-system

Flux is responsible to manage the applications in the cluster. Since the first step is to set up Flux is a good idea to back up flux-system (namespace where the flux resources are deployed) because in case of disaster we can restore flux from a backup (otherwise it would be mannualy installed).


* Schedule a daily backup for flux-system by executing the command:

```
velero schedule create flux-system-backup --include-namespaces flux-system --storage-location azure --schedule "0 7 * * *" --
```

* Validate the schedule creation by doing:
```
velero schedule get
```

* The result should be:
```
MSBoilerplate-GITOPS eduardopiairo$ velero schedule get
NAME                 STATUS    CREATED                          SCHEDULE    BACKUP TTL   LAST BACKUP   SELECTOR   PAUSED
flux-system-backup   Enabled   2023-05-30 14:50:51 +0100 WEST   0 7 * * *   0s           n/a           <none>     false
```


### Backup Prometheus 

Prometheus is used to store metrics. 

* Schedule a daily backup for Prometheus by executing the command:

```
velero schedule create prometheus-backup --include-namespaces istio-system --include-resources pvc,pv --storage-location azure --schedule "0 7 * * *"
```

* The above command will backup only persistante volume calaims (pvc) and persistent volumes (pv). Alternatively, you can make make a backup of the entire namespace:
```
velero schedule create prometheus-backup --include-namespaces istio-system --storage-location azure --schedule "0 7 * * *"
```

* The result should be:
```
MSBoilerplate-GITOPS eduardopiairo$ velero schedule get
NAME                 STATUS    CREATED                          SCHEDULE    BACKUP TTL   LAST BACKUP   SELECTOR   PAUSED
flux-system-backup   Enabled   2023-05-30 14:50:51 +0100 WEST   0 7 * * *   0s           n/a           <none>     false
prometheus-backup    Enabled   2023-05-30 14:53:59 +0100 WEST   0 7 * * *   0s           n/a           <none>     false
```


### Backup MongoDB

MonoDB is the database used to store application data.

* Schedule a hourly backup for MongoDB by executing the command:
```
velero schedule create mongodb-backup --include-namespaces mongodb --include-resources pvc,pv --storage-location azure --schedule "0 * * * *"
```

Alternatively, you can make make a backup of the entire namespace:
```
velero schedule create mongodb-backup --include-namespaces mongodb --storage-location azure --schedule "0 * * * * *"
```

* The result should be:
```
MSBoilerplate-GITOPS eduardopiairo$ velero schedule get
NAME                 STATUS    CREATED                          SCHEDULE    BACKUP TTL   LAST BACKUP   SELECTOR   PAUSED
flux-system-backup   Enabled   2023-05-30 14:50:51 +0100 WEST   0 7 * * *   0s           n/a           <none>     false
mongodb-backup       Enabled   2023-05-30 15:05:11 +0100 WEST   0 * * * *   0s           n/a           <none>     false
prometheus-backup    Enabled   2023-05-30 14:53:59 +0100 WEST   0 7 * * *   0s           n/a           <none>     false
```

* INFO: After creating the schedule backup, you can trigger it manually using the command:
```
velero backup create --from-schedule NAME-OF-THE-BACKUP
```


## Restore

You can restore a backup with the command:

```
velero restore create --from-backup NAME-OF-THE-BACKUP
```


## Retention period
The default backup retention period, expressed as TTL (time to live), is 30 days (720 hours).

You can use the --ttl <DURATION> flag to change this as necessary.

Example:
```
velero schedule create flux-system-backup --include-namespaces flux-system --storage-location azure --schedule "0 7 * * *" --ttl 2160h0m0s
```


## Usefull velereo commands

### Get schedules
```
velero schedule get
```

### Delete schedule
```
velero schedule delete SCHEDULE-NAME
```

### Pause a schedule
```
velero schedule pause SCHEDULE-NAME
```

### Unpause a schedule
```
velero schedule unpause SCHEDULE-NAME
```
