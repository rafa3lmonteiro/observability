# Introduction to Velero
Official documentation: [Velero documentation](https://velero.io/docs/)

# We need an AKS cluster running with deployments/services/...

# Velero CLI install

Velero [releases](https://github.com/vmware-tanzu/velero/releases) </br>

* Macro tasks to install Velero CLI in a Linux based terminal (it is considered the version 1.9.5):

```
curl -L -o /tmp/velero.tar.gz https://github.com/vmware-tanzu/velero/releases/download/v1.9.5/velero-v1.9.5-linux-amd64.tar.gz
tar -C /tmp -xvf /tmp/velero.tar.gz
mv /tmp/velero-v1.9.5-linux-amd64/velero /usr/local/bin/velero
chmod +x /usr/local/bin/velero

velero --help
```

* Velero installation and backups by default are run in the velero namespace. However, it is possible to use a different namespace. To have namespace consistency, specify the namespace for all Velero operational commands to be the same as the namespace used to install Velero:
```
velero client config set namespace=<NAMESPACE_VALUE>
```

# Create storage account and use it as Velero backup location

* Login to azure in your Linux based terminal with: 

**IMPORTANT** Change the "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" values!

```
az login --tenant xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
az account set --subscription xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

######################################################
### SETUP AZURE STORAGE ACCOUNT AND BLOB CONTAINER ###
######################################################

* Setting up this variables on your local shell:

**IMPORTANT** Remember to change AZURE_BACKUP_SUBSCRITPION_ID value for your subscription ID before to execute this

```
AZURE_SUBSCRIPTION_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_TENANT_ID=119ca644-d1ee-49a6-b0b4-43515deb6754
AZURE_RESOURCE_GROUP=velero
AZURE_STORAGE_ACCOUNT_NAME=velero$RANDOM
STORAGE_SKU=Standard_LRS
BLOB_CONTAINER=mycluster
LOCATION=northeurope
```

# Create velero resource group
This is the Resource Group where all backups defenition will be stored.

```
az group create -n $AZURE_RESOURCE_GROUP --location $LOCATION
```
Example:
```
az group create -n velero --location northeurope
```

# Create storage account
```
az storage account create \
    --name $AZURE_STORAGE_ACCOUNT_NAME \
    --resource-group $AZURE_RESOURCE_GROUP \
    --sku $STORAGE_SKU
```

Example:
```
az storage account create \
    --name velero01 \
    --resource-group velero \
    --sku Standard_LRS
```

# Get storage account key
```
AZURE_STORAGE_ACCOUNT_ACCESS_KEY=`az storage account keys list --account-name $AZURE_STORAGE_ACCOUNT_NAME --query "[?keyName == 'key1'].value" -o tsv`
```

# Create velero blob container
```
az storage container create -n $BLOB_CONTAINER \
  --public-access off \
  --account-name $AZURE_STORAGE_ACCOUNT_NAME \
  --account-key $AZURE_STORAGE_ACCOUNT_ACCESS_KEY
```

Example
```
az storage container create -n mycluster \
  --public-access off \
  --account-name velero01 \
  --account-key XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX==
```            

# Create velero service principal

**IMPORTANT** In order to create a service principal the user needs the role "Application Administrator" in the Azure Tenant!

```
AZURE_CLIENT_SECRET=`az ad sp create-for-rbac --name "velero" --role "Contributor" --query 'password' -o tsv --scopes  /subscriptions/$AZURE_SUBSCRIPTION_ID`
AZURE_CLIENT_ID=`az ad sp list --display-name "velero" --query '[0].appId' -o tsv`
```

# Or use an existing service principal (replace "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" with real values)
AZURE_CLIENT_SECRET=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

**IMPORTANT** If an existing service principal is used, this SP needs the role "Contributor" in the subscription!

Get resource group containing your VMs and disks


#######################################################
### GET RESOURCE GROUP CONTAINING YOR VMS and DISKS ###
#######################################################

Get resource group that contains your Kubernestes cluster's virtual machines/disks.

The value of AZURE_RESOURCE_GROUP shoud contain the name of the resource where the the disks are, and then the VolumeSnapshotLocation (file base/velero/velero-install.yaml, line 3014) should have the name of the resource group where you want to store the snapshots.

# Generating the seleaded secret for velero

## Run the following command in your linux terminal (replace "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" with real values):
```
echo "AZURE_SUBSCRIPTION_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_TENANT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_SECRET=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_RESOURCE_GROUP=MC_rg-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
AZURE_CLOUD_NAME=AzurePublicCloud" | base64
```

## For example, the next command:
```
echo "AZURE_SUBSCRIPTION_ID=my-test-subscription
AZURE_TENANT_ID=my-test-tenant
AZURE_CLIENT_ID=my-test-client-id
AZURE_CLIENT_SECRET=my-test-client-secret
AZURE_RESOURCE_GROUP=MC_rg-platforms-neu-1_aks-platforms-neu-1_northeurope
AZURE_CLOUD_NAME=AzurePublicCloud" | base64
```
## Will output the following:
```
echo "AZURE_SUBSCRIPTION_ID=my-test-subscription
AZURE_TENANT_ID=my-test-tenant
AZURE_CLIENT_ID=my-test-client-id
AZURE_CLIENT_SECRET=my-test-client-secret
AZURE_RESOURCE_GROUP=MC_rg-platforms-neu-1_aks-platforms-neu-1_northeurope
AZURE_CLOUD_NAME=AzurePublicCloud" | base64
QVpVUkVfU1VCU0NSSVBUSU9OX0lEPW15LXRlc3Qtc3Vic2NyaXB0aW9uCkFaVVJFX1RFTkFOVF9JRD1teS10ZXN0LXRlbmFudApBWlVSRV9DTElFTlRfSUQ9bXktdGVzdC1jbGllbnQtaWQKQVpVUkVfQ0xJRU5UX1NFQ1JFVD1teS10ZXN0LWNsaWVudC1zZWNyZXQKQVpVUkVfUkVTT1VSQ0VfR1JPVVA9TUNfcmctcGxhdGZvcm1zLW5ldS0xX2Frcy1wbGF0Zm9ybXMtbmV1LTFfbm9ydGhldXJvcGUKQVpVUkVfQ0xPVURfTkFNRT1BenVyZVB1YmxpY0Nsb3VkCg==
```

## Put together the output in one line, removing the line breakers, for example:
```
QVpVUkVfU1VCU0NSSVBUSU9OX0lEPW15LXRlc3Qtc3Vic2NyaXB0aW9uCkFaVVJFX1RFTkFOVF9JRD1teS10ZXN0LXRlbmFudApBWlVSRV9DTElFTlRfSUQ9bXktdGVzdC1jbGllbnQtaWQKQVpVUkVfQ0xJRU5UX1NFQ1JFVD1teS10ZXN0LWNsaWVudC1zZWNyZXQKQVpVUkVfUkVTT1VSQ0VfR1JPVVA9TUNfcmctcGxhdGZvcm1zLW5ldS0xX2Frcy1wbGF0Zm9ybXMtbmV1LTFfbm9ydGhldXJvcGUKQVpVUkVfQ0xPVURfTkFNRT1BenVyZVB1YmxpY0Nsb3VkCg==
```


**REMEMBER** to insert the result of each SECRETS on the original-secrets-velero.yaml file below:
# create the original secret, executing the following command (Replace "<cluster_name>" with a desired value. Also replace the key "cloud" value with the previous base64 value):
```
cat << EOF > ./clusters/<cluster_name>/secrets/original-secrets-velero.yaml
apiVersion: v1
kind: Secret
metadata:
  name: velero
  namespace: velero
type: Opaque
data:
  cloud: QVpVUkVfU1VCU0NSSVBUSU9OX0lEPW15LXRlc3Qtc3Vic2NyaXB0aW9uCkFaVVJFX1RFTkFOVF9JRD1teS10ZXN0LXRlbmFudApBWlVSRV9DTElFTlRfSUQ9bXktdGVzdC1jbGllbnQtaWQKQVpVUkVfQ0xJRU5UX1NFQ1JFVD1teS10ZXN0LWNsaWVudC1zZWNyZXQKQVpVUkVfUkVTT1VSQ0VfR1JPVVA9TUNfcmctcGxhdGZvcm1zLW5ldS0xX2Frcy1wbGF0Zm9ybXMtbmV1LTFfbm9ydGhldXJvcGUKQVpVUkVfQ0xPVURfTkFNRT1BenVyZVB1YmxpY0Nsb3VkCg==
EOF
```

# generate the sealed secret, executing the following command (replace the variables "<cluster_name_context>" and "<cluster_name>" with desired values):
```
# kubeseal -o yaml --context <cluster_name_context> --controller-namespace flux-system --cert=./clusters/<cluster_name>/secrets/dev-sealed-secrets.pem <./clusters/<cluster_name>/secrets/original-secrets-velero.yaml >./clusters/<cluster_name>/secrets/velero-sealed-secrets.yaml
```

# delete the original secret, because it should not be pushed to the repository! (replace the variable "<cluster_name>" with desired value)
```
rm ./clusters/<cluster_name>/secrets/original-secrets-velero.yaml
```


# Push the created resources to the repository

```
git add . && git commit -m "Uploading velero sealed secret encrypted file to cluster" && git push
```

# Uncomment "velero-sealed-secrets.yaml" in "./clusters/<cluster_name>/secrets/kustomization.yaml" like the following example:

./clusters/<cluster_name>/secrets/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
#- <environemnt>-sealed-secrets.yaml
- sealed-secrets-install.yaml
- velero-sealed-secrets.yaml
```

# Push the uncommented velero sealed secret kustomization to the repository:

```
git add . && git commit -m "Uncommented velero sealed secret kustomization" && git push
```

# Go to "./base/velero/velero-install.yaml" and change:
- line 3079 with the content of the variable $BLOB_CONTAINER
- line 3081 with the content of the variable $AZURE_RESOURCE_GROUP
- line 3082 with the content of the variable $AZURE_STORAGE_ACCOUNT_NAME
- line 3083 with the content of the variable $AZURE_SUBSCRIPTION_ID

- line 3104 with the content of the variable $AZURE_RESOURCE_GROUP (Resource Group where you want to store the disks's snapshots)
- line 3105 with the content of the variable $AZURE_SUBSCRIPTION_ID


# Uncomment "velero" in "./base/kustomization.yaml" like the following example:

./base/kustomization.yaml
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- app
- monitoring
- service_mesh
- velero
```

# Push the uncommented velero kustomization to the repository:

```
git add . && git commit -m "Uncommented velero kustomization" && git push
```

# Wait for the flux reconciliation and check that velero is running in the cluster


```
kubectl get deployment/velero -n velero
kubectl logs deployment/velero -n velero
```


# Note:
The velero helm template was generated with the following command (some modifications were made to the template after the creation):
```
helm repo add vmware-tanzu https://vmware-tanzu.github.io/helm-charts

helm template velero vmware-tanzu/velero \
--include-crds \
--namespace velero \
--create-namespace \
--set-file credentials.secretContents.cloud=/tmp/credentials-velero \
--set configuration.backupStorageLocation[0].provider=azure \
--set configuration.backupStorageLocation[0].bucket=mycluster \
--set configuration.backupStorageLocation[0].config.resourceGroup=velero \
--set configuration.backupStorageLocation[0].config.subscriptionId=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \
--set configuration.backupStorageLocation[0].config.storageAccount=velero20 \
--set configuration.volumeSnapshotLocation[0].name=default \
--set configuration.volumeSnapshotLocation[0].provider=azure \
--set configuration.volumeSnapshotLocation[0].config.apiTimeout=5m \
--set configuration.volumeSnapshotLocation[0].config.resourceGroup=velero \
--set configuration.volumeSnapshotLocation[0].config.subscriptionId=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \
--set configuration.volumeSnapshotLocation[0].config.incremental=true \
--set initContainers[0].name=velero-plugin-for-azure \
--set initContainers[0].image=velero/velero-plugin-for-microsoft-azure:v1.6.0 \
--set initContainers[0].volumeMounts[0].mountPath=/target \
--set initContainers[0].volumeMounts[0].name=plugins > ./base/velero/velero-install.yaml
```